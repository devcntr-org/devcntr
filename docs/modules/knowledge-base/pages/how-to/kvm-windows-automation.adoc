= Windows Automation via KVM
:description: How to use KVM/QEMU Guest Agent and SSH to automate Windows testing workflows from a Linux host.

Automating a Windows VM from a Linux host allows you to treat your test environment like a CI runner. This guide covers setting up bidirectional communication and managing VM state for repeatable testing.

== Prerequisites

* A Windows 10/11 VM running on KVM/QEMU (libvirt).
* `virtio-win` drivers installed in the guest.
* `qemu-guest-agent` service running in the guest.

== 1. Setting up the Guest Agent

The **QEMU Guest Agent (QGA)** is the most robust channel for host-to-guest communication. It doesn't require a network connection and allows file transfers and command execution.

=== Enable the Channel in XML
Add the following channel to your VM's domain XML (via `virsh edit <vm-name>`):

[source,xml]
----
<channel type='unix'>
  <target type='virtio' name='org.qemu.guest_agent.0'/>
  <address type='virtio-serial' controller='0' bus='0' port='1'/>
</channel>
----

=== Run Commands from Linux
Use `virsh` to execute commands and capture stdout:

[source,bash]
----
# Execute a command
virsh qemu-agent-command <vm-name> \
  '{"execute":"guest-exec","arguments":{"path":"cmd.exe","arg":["/c","dir"],"capture-output":true}}'

# Poll for results (using the PID returned from the command above)
virsh qemu-agent-command <vm-name> \
  '{"execute":"guest-exec-status","arguments":{"pid":123}}'
----

== 2. Snapshot Orchestration

For testing installers, you need to ensure the system starts from a known state every time.

=== Creating a Baseline
1. Install all required GUI dependencies and plugins.
2. Configure the application to the desired "ready" state.
3. Take a snapshot:
+
[source,bash]
----
virsh snapshot-create-as <vm-name> clean-state "Baseline for testing"
----

=== Reverting for New Tests
Before every test run, revert to your baseline:

[source,bash]
----
virsh snapshot-revert <vm-name> clean-state
----

== 3. GUI Interaction

If your installer is "GUI-only," you can still automate it using one of two methods:

* **In-Guest Automation:** Use **PowerShell UIAutomation**, **AutoHotkey**, or **pywinauto**. Your script can be uploaded via QGA and executed locally.
* **Host-Injected Events:** QEMU can inject keyboard and mouse events directly into the guest.
+
[source,bash]
----
# Send keys to the guest
virsh send-key <vm-name> KEY_LEFTMETA KEY_R
----

== 4. Recommended Automation Stack

|===
| Channel | Best For

| **QEMU Guest Agent** | File I/O, process execution without network.
| **OpenSSH (Win 10+)** | Traditional remote execution, file sync via SCP.
| **WinRM** | Native PowerShell remoting and orchestration.
|===

[TIP]
====
Combine **Snapshots** with **OpenSSH** for the best balance of speed and reliability. Revert to a snapshot with SSH enabled, sync your build, and run your tests.
====
